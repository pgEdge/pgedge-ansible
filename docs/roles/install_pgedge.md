# install_pgedge

## Overview

The `install_pgedge` role installs pgEdge Enterprise Postgres packages on target systems. This includes Postgres server binaries, the Spock logical replication extension, Snowflake extension, and Python Postgres drivers.

## Purpose

- Install pgEdge Enterprise Postgres server packages
- Install pgEdge extensions (Spock, Snowflake)
- Install Python Postgres adapter (psycopg2)
- Ensure all components match the configured Postgres version

## Role Dependencies

- `role_config` - Provides Postgres version and configuration
- `install_repos` - Must be run first to configure package repositories

## When to Use

Execute this role on **all pgedge hosts** after configuring repositories and before setting up Postgres instances:

```yaml
- hosts: pgedge
  collections:
    - pgedge.platform
  roles:
    - install_repos
    - install_pgedge
```

## Parameters

This role uses the following configuration parameters:

* `pg_version`

## Tasks Performed

### 1. Package Installation

Installs Postgres server and client binaries, along with supplementary packages.

**pgEdge software and extensions:**

- lolor extension for Large Object (LOB) support in logical replication
- Snowflake extension for unique ID generation
- Spock extension for bidirectional logical replication

**Community and other popular tools:**

- [pgAdmin](https://www.pgadmin.org/) GUI administration tool
- [PGAudit](https://www.pgaudit.org/) query and session auditing extension
- [PgBouncer](https://www.pgbouncer.org/) connection pooler
- [pgvector](https://github.com/pgvector/pgvector) Vector database extension
- [PostGIS](https://postgis.net/) geospatial extension for Geographic Information Systems

**Python Postgres Adapter:**

- `pgedge-python3-psycopg2` - Python database adapter

### 2. Retry Logic

The role includes robust retry logic:

- Attempts installation up to 5 times
- Waits 20 seconds between retries
- Handles transient network or repository issues
- Ensures successful installation before proceeding

### 3. Version Pinning

- Always installs the latest available packages for the specified Postgres version
- Maintains consistency across all nodes in the cluster

## Files Generated

Aside from any files generated by package installation, this role does not modify any files during execution.

## Platform-Specific Behavior

### Debian-Family

- Package name: `pgedge-enterprise-all-{{ pg_version }}`
- Uses APT package manager
- Packages install to `/usr/lib/postgresql/{{ pg_version }}/`
- Creates systemd service: `postgresql`

### RHEL-Family

- Package name: `pgedge-enterprise-all_{{ pg_version }}`
- Uses DNF package manager
- Installs to `/usr/pgsql-{{ pg_version }}/`
- Creates systemd service: `postgresql-{{ pg_version }}`

## Example Usage

### Basic Installation

```yaml
- hosts: pgedge
  collections:
    - pgedge.platform
  roles:
    - install_repos
    - install_pgedge
```

### Install Specific Postgres Version

```yaml
- hosts: pgedge
  collections:
    - pgedge.platform
  vars:
    pg_version: 16  # Install Postgres 16
  roles:
    - install_repos
    - install_pgedge
```

### Install on Multiple Node Groups

```yaml
# Install on primary cluster nodes
- hosts: pgedge
  roles:
    - install_repos
    - install_pgedge

# Install on backup server (for verification/restoration)
- hosts: backup
  roles:
    - install_repos
    - install_pgedge
```

## Idempotency

This role is fully idempotent:

- Re-running will update packages to latest versions if available
- If packages are already at latest version, no changes are made
- Safe to include in repeated playbook runs
- Will not disrupt running Postgres instances

## Troubleshooting

### Package Not Found

**Symptom:** Package installation fails with "package not found" error

**Solution:**

- Verify `install_repos` role completed successfully
- Check package cache is updated:

```bash
# Debian/Ubuntu
sudo apt update
apt-cache search pgedge-enterprise

# RHEL/Rocky
sudo dnf makecache
dnf search pgedge-enterprise
```

- Verify correct repository is configured:

```bash
# Debian/Ubuntu
cat /etc/apt/sources.list.d/pgedge.sources

# RHEL/Rocky
cat /etc/yum.repos.d/pgedge.repo
```

### Version Mismatch

**Symptom:** Wrong Postgres version installed

**Solution:**

- Verify `pg_version` variable is set correctly
- Check available package versions:

```bash
# Debian/Ubuntu
apt-cache policy pgedge-enterprise-all-17

# RHEL/Rocky
dnf list pgedge-enterprise-all_17
```

- Ensure version-specific package exists in repository

### Dependency Conflicts

**Symptom:** Package installation fails due to dependency conflicts

**Solution:**

- Check for conflicting Postgres installations:

```bash
# List installed Postgres packages
dpkg -l | grep postgres  # Debian/Ubuntu
rpm -qa | grep postgres  # RHEL/Rocky
```

- Remove conflicting packages if safe:

```bash
# Debian/Ubuntu
sudo apt remove [conflicting packages]

# RHEL/Rocky
sudo dnf remove [conflicting packages]
```

### Network Timeouts

**Symptom:** Package downloads timeout or fail intermittently

**Solution:**

- The role includes 5 retries with 20-second delays
- For persistent issues, check network connectivity
- Verify repository servers are accessible
- Consider using a local package mirror

### Lock Timeout on Debian

**Symptom:** "Could not get lock" error on Debian/Ubuntu

**Solution:**

- Check for hung apt processes:

```bash
ps aux | grep apt
```

- Wait for other package operations to complete

### psycopg2 Installation Fails

**Symptom:** Python psycopg2 package fails to install

**Solution:**

- Verify Python 3 is installed:

```bash
python3 --version
```

- Install development headers if needed:

```bash
# Debian/Ubuntu
sudo apt install python3-dev libpq-dev

# RHEL/Rocky
sudo dnf install python3-devel postgresql-devel
```

## Notes

!!! note "Automatic Updates"
    This role uses `state: latest` to ensure packages are updated to the newest version. This is intentional to maintain security and stability. Package updates will restart the Postgres service.

## See Also

- [Configuration Reference](../configuration.md) - Complete variable documentation
- [role_config](role_config.md) - Postgres version and configuration variables
- [install_repos](install_repos.md) - Required prerequisite for repository configuration
- [setup_postgres](setup_postgres.md) - Configures Postgres instances after installation
