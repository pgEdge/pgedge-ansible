---

- name: Create configuration file for Patroni node
  template:
    src: files/patroni.yaml.j2
    dest: "{{ patroni_config_dir }}/patroni.yaml"
    mode: 0600

- name: Enable and start the Patroni service
  systemd_service:
    daemon_reload: true
    name: patroni
    enabled: true
    state: started
  become: true

# Patroni should restart nodes with changes which require restart, but doesn't.
# We use the patronictl tool because a direct Postgres restart won't change the
# "Pending restart" flag in the Patroni cluster status.

- name: Restart Postgres service to incorporate configuration changes
  shell: |
    cd {{ patroni_bin_dir }}
    ./patronictl -c {{ patroni_config_dir }}/patroni.yaml \
                 restart pgedge {{ ansible_hostname }} \
                 --force
